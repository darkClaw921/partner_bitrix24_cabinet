version: "3.8"

services:
  b24-service:
    build:
      context: ./b24-transfer-lead
      dockerfile: Dockerfile.backend
    volumes:
      - ./b24-transfer-lead/src/backend:/app/src/backend
      - b24-data:/app/data
    environment:
      - MAIN_DB_URL=${B24_MAIN_DB_URL:-sqlite:///./data/main.db}
      - WORKFLOWS_DIR=${B24_WORKFLOWS_DIR:-./data/workflows}
      - SECRET_KEY=${B24_SECRET_KEY:-dev-b24-secret}
      - INTERNAL_API_KEY=${B24_INTERNAL_API_KEY:-dev-internal-api-key}
      - ADMIN_USERNAME=${B24_ADMIN_USERNAME:-cabinet_admin}
      - ADMIN_PASSWORD=${B24_ADMIN_PASSWORD:-cabinet_admin_pass}
      - ENABLE_DOCS=${B24_ENABLE_DOCS:-true}
      - FRONTEND_URL=${B24_FRONTEND_URL:-http://localhost:5173}
    command: uv run uvicorn src.backend.main:app --host 0.0.0.0 --port 7860 --reload

  b24-frontend:
    image: node:20-alpine
    working_dir: /app
    volumes:
      - ./b24-transfer-lead/src/frontend:/app
      - b24-frontend-modules:/app/node_modules
    environment:
      - VITE_BASE_PATH=/b24/
      - VITE_API_TARGET=http://b24-service:7860
    command: sh -c "npm install && npm run dev -- --host 0.0.0.0"
    depends_on:
      - b24-service

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8003:8003"
    volumes:
      - ./backend:/app
      - ./data:/app/data
    environment:
      - DATABASE_URL=${BACKEND_DATABASE_URL:-sqlite+aiosqlite:///./data/app.db}
      - SECRET_KEY=${BACKEND_SECRET_KEY:-dev-secret-key-change-in-production}
      - CORS_ORIGINS=${BACKEND_CORS_ORIGINS:-["http://localhost:5173"]}
      - B24_SERVICE_URL=${BACKEND_B24_SERVICE_URL:-http://b24-service:7860}
      - B24_INTERNAL_API_KEY=${B24_INTERNAL_API_KEY:-dev-internal-api-key}
      - B24_WEBHOOK_URL=${B24_WEBHOOK_URL:-}
      - B24_ENTITY_TYPE=${B24_ENTITY_TYPE:-lead}
      - B24_DEAL_CATEGORY_ID=${B24_DEAL_CATEGORY_ID:-}
      - B24_DEAL_STAGE_ID=${B24_DEAL_STAGE_ID:-}
      - B24_LEAD_STATUS_ID=${B24_LEAD_STATUS_ID:-NEW}
      - B24_FIELD_MAPPINGS=${B24_FIELD_MAPPINGS:-[]}
      - DEFAULT_REWARD_PERCENTAGE=${DEFAULT_REWARD_PERCENTAGE:-10.0}
      - ADMIN_EMAIL=${BACKEND_ADMIN_EMAIL:-admin@partner-cabinet.com}
      - ADMIN_PASSWORD=${BACKEND_ADMIN_PASSWORD:-admin123456}
      - B24_SERVICE_FRONTEND_URL=${BACKEND_B24_SERVICE_FRONTEND_URL:-/b24/}
    command: uvicorn app.main:app --host 0.0.0.0 --port 8003 --reload
    depends_on:
      - b24-service

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    command: npm run dev -- --host 0.0.0.0
    depends_on:
      - backend
      - b24-frontend

  telegram-bot:
    build:
      context: ./telegram_bot
      dockerfile: Dockerfile
    volumes:
      - ./telegram_bot:/app
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - BACKEND_URL=http://backend:8003
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL:-http://localhost:8003}
      - NOTIFICATION_POLL_INTERVAL=${NOTIFICATION_POLL_INTERVAL:-60}
    command: python -m bot.main
    depends_on:
      - backend
    restart: unless-stopped

volumes:
  b24-data:
  b24-frontend-modules:
